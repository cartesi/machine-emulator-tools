#include "libcmt/abi.h"
#include <assert.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

// EvmAdvance(address,uint256,uint256,uint256,bytes)
#define ADVANCE CMT_ABI_FUNSEL(0xd2, 0x0c, 0x60, 0xb4)

// Voucher(address,bytes)
#define VOUCHER CMT_ABI_FUNSEL(0xef, 0x61, 0x5e, 0x2f)

// Notice(bytes)
#define NOTICE CMT_ABI_FUNSEL(0xc2, 0x58, 0xd6, 0xe5)

static int memeq(uint8_t *x, uint8_t *y, size_t n, const char *file, int line) {
    for (size_t i = 0; i < n; ++i)
        if (x[i] != y[i]) {
            fprintf(stderr, "%s:%d Missmatch at offset %zu (0x%02x != 0x%02x)\n", file, line, i, x[i], y[i]);
            cmt_buf_xxd(x, x + n, 0x20);
            cmt_buf_xxd(y, y + n, 0x20);
            return -1;
        }
    return 0;
}

static int advance(void) {
    // cast calldata "EvmAdvance(address,uint256,uint256,uint256,bytes)" `cast address-zero` 1 2 3 0xdeadbeef | xxd -r
    // -p | xxd -n advance -i
    uint8_t evm_advance[] = {0xd2, 0x0c, 0x60, 0xb4, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x04, 0xde, 0xad, 0xbe, 0xef, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
    uint8_t mem[256];
    cmt_buf_t bb[1] = {{mem, mem + sizeof mem}}, wr[1] = {*bb}, of[1];

    uint8_t address[20] = {0};
    uint8_t bytes[] = {0xde, 0xad, 0xbe, 0xef};

    cmt_abi_put_funsel(wr, ADVANCE);
    uint8_t *frame = wr->begin; // dynamic frame begins after funsel
    cmt_abi_put_address(wr, address);
    cmt_abi_put_uint(wr, sizeof(int), &(int[]){1});
    cmt_abi_put_uint(wr, sizeof(int), &(int[]){2});
    cmt_abi_put_uint(wr, sizeof(int), &(int[]){3});
    cmt_abi_put_bytes_s(wr, of);
    cmt_abi_put_bytes_d(wr, of, sizeof bytes, bytes, frame);

    return sizeof evm_advance != (wr->begin - bb->begin) ||
        memeq(evm_advance, bb->begin, sizeof evm_advance, __FILE__, __LINE__);
}

static int voucher(void) {
    // cast calldata "Voucher(address,bytes)" `cast address-zero` 0xdeadbeef | xxd -r -p | xxd -n voucher -i
    unsigned char evm_voucher[] = {0xef, 0x61, 0x5e, 0x2f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0xde, 0xad, 0xbe, 0xef,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

    uint8_t mem[256];
    cmt_buf_t bb[1] = {{mem, mem + sizeof mem}}, wr[1] = {*bb}, of[1];

    uint8_t address[20] = {0};
    uint8_t bytes[] = {0xde, 0xad, 0xbe, 0xef};

    cmt_abi_put_funsel(wr, VOUCHER);
    uint8_t *frame = wr->begin; // dynamic frame begins after funsel
    cmt_abi_put_address(wr, address);
    cmt_abi_put_bytes_s(wr, of);
    cmt_abi_put_bytes_d(wr, of, sizeof bytes, bytes, frame);

    return sizeof evm_voucher != (wr->begin - bb->begin) ||
        memeq(evm_voucher, bb->begin, sizeof evm_voucher, __FILE__, __LINE__);
}

static int notice(void) {
    unsigned char evm_notice[] = {0xc2, 0x58, 0xd6, 0xe5, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04,
        0xde, 0xad, 0xbe, 0xef, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

    uint8_t mem[256];
    cmt_buf_t bb[1] = {{mem, mem + sizeof mem}}, wr[1] = {*bb}, of[1];

    uint8_t bytes[] = {0xde, 0xad, 0xbe, 0xef};

    cmt_abi_put_funsel(wr, NOTICE);
    uint8_t *frame = wr->begin; // dynamic frame begins after funsel
    cmt_abi_put_bytes_s(wr, of);
    cmt_abi_put_bytes_d(wr, of, sizeof bytes, bytes, frame);

    return sizeof evm_notice != (wr->begin - bb->begin) ||
        memeq(evm_notice, bb->begin, sizeof evm_notice, __FILE__, __LINE__);
}

int main(void) {
    assert(advance() == 0);
    assert(voucher() == 0);
    assert(notice() == 0);
    return 0;
}
